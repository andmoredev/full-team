name: Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy-ecr:
    name: Deploy ECR Repositories
    outputs:
      ecr_uri: ${{ steps.get_outputs.outputs.ecr_uri }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.PIPELINE_EXECUTION_ROLE }}

      - name: Validate template
        working-directory: backend
        run: |
          sam validate -t template-ecr.yaml

      - name: Deploy ECR stack
        working-directory: backend
        run: |
            sam build \
              --template-file template-ecr.yaml \
              --config-file samconfig-ecr.yaml \
              --config-env dev

            sam deploy \
              --template-file template-ecr.yaml \
              --config-file samconfig-ecr.yaml \
              --config-env dev \
              --s3-bucket "${{ secrets.ARTIFACTS_BUCKET_NAME }}" \
              --role-arn "${{ secrets.CLOUDFORMATION_EXECUTION_ROLE }}" \
              --no-fail-on-empty-changeset

      - name: Get Stack Outputs
        working-directory: backend
        id: get_outputs
        run: |
            sam list stack-outputs \
              --config-file samconfig-ecr.yaml \
              --config-env dev \
              > sam_deploy.json
            ECR_URI=$(jq -r '.[] | select(.OutputKey=="BoilerplateAgentEcrRepositoryUri") | .OutputValue' sam_deploy.json)
            echo "ecr_uri=$ECR_URI" >> $GITHUB_OUTPUT
            echo "ECR URI: $ECR_URI" >> $GITHUB_STEP_SUMMARY

  build-and-push-image:
      name: Build & Push Boilerplate Agent Image
      needs: deploy-ecr
      runs-on: ubuntu-24.04-arm
      permissions:
        id-token: write
        contents: read
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Configure AWS
          uses: aws-actions/configure-aws-credentials@v5
          with:
            aws-region: us-east-1
            role-to-assume: ${{ secrets.PIPELINE_EXECUTION_ROLE }}

        - name: Derive repository and region
          id: derive
          run: |
            ECR_URI='${{ needs.deploy-ecr.outputs.ecr_uri }}'
            if [ -z "$ECR_URI" ]; then
              echo "Missing ECR URI from previous job" >&2
              exit 1
            fi
            ACCOUNT_ID=$(echo "$ECR_URI" | awk -F'.' '{print $1}')
            REGION=$(echo "$ECR_URI" | awk -F'.' '{print $4}')
            REPO_NAME=$(echo "$ECR_URI" | awk -F'/' '{print $2}')
            echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
            echo "region=$REGION" >> $GITHUB_OUTPUT
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
            echo "Using repo $REPO_NAME in $REGION (account $ACCOUNT_ID)" >> $GITHUB_STEP_SUMMARY

        - name: Log in to ECR
          run: |
            aws ecr get-login-password --region ${{ steps.derive.outputs.region }} | docker login --username AWS --password-stdin ${{ steps.derive.outputs.account_id }}.dkr.ecr.${{ steps.derive.outputs.region }}.amazonaws.com

        - name: Build Image
          working-directory: backend/src/agents/boilerplate
          id: build
          run: |
            IMAGE_TAG=latest
            docker build -t ${{ steps.derive.outputs.repo_name }}:$IMAGE_TAG .
            docker tag ${{ steps.derive.outputs.repo_name }}:$IMAGE_TAG ${{ steps.derive.outputs.account_id }}.dkr.ecr.${{ steps.derive.outputs.region }}.amazonaws.com/${{ steps.derive.outputs.repo_name }}:$IMAGE_TAG
            SHORT_SHA=${GITHUB_SHA::12}
            docker tag ${{ steps.derive.outputs.repo_name }}:$IMAGE_TAG ${{ steps.derive.outputs.account_id }}.dkr.ecr.${{ steps.derive.outputs.region }}.amazonaws.com/${{ steps.derive.outputs.repo_name }}:$SHORT_SHA
            echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
            echo "Built tags: $IMAGE_TAG and $SHORT_SHA" >> $GITHUB_STEP_SUMMARY

        - name: Push Image
          id: push
          run: |
            SHORT_SHA='${{ steps.build.outputs.short_sha }}'
            docker push ${{ steps.derive.outputs.account_id }}.dkr.ecr.${{ steps.derive.outputs.region }}.amazonaws.com/${{ steps.derive.outputs.repo_name }}:latest
            docker push ${{ steps.derive.outputs.account_id }}.dkr.ecr.${{ steps.derive.outputs.region }}.amazonaws.com/${{ steps.derive.outputs.repo_name }}:$SHORT_SHA || true
            echo "latest_image=${{ steps.derive.outputs.account_id }}.dkr.ecr.${{ steps.derive.outputs.region }}.amazonaws.com/${{ steps.derive.outputs.repo_name }}:latest" >> $GITHUB_OUTPUT
            echo "sha_image=${{ steps.derive.outputs.account_id }}.dkr.ecr.${{ steps.derive.outputs.region }}.amazonaws.com/${{ steps.derive.outputs.repo_name }}:$SHORT_SHA" >> $GITHUB_OUTPUT
            echo "Pushed latest and $SHORT_SHA" >> $GITHUB_STEP_SUMMARY

  package-and-upload-agent:
    name: Package & Upload Boilerplate Agent for Direct Deploy
    needs: deploy-ecr
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.PIPELINE_EXECUTION_ROLE }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Package agent
        working-directory: backend
        run: |
          AGENT_DIR="src/agents/boilerplate"
          BUILD_DIR="/tmp/boilerplate-agent-build"
          ZIP_FILE="/tmp/boilerplate-agent.zip"

          echo "Packaging boilerplate agent for direct code deployment..."

          # Clean up previous builds
          rm -rf "$BUILD_DIR"
          rm -f "$ZIP_FILE"

          # Create build directory
          mkdir -p "$BUILD_DIR"

          # Copy agent code
          echo "Copying agent code..."
          cp "$AGENT_DIR/agent.py" "$BUILD_DIR/"
          cp "$AGENT_DIR/requirements.txt" "$BUILD_DIR/"

          # Install dependencies for ARM64 architecture
          echo "Installing dependencies for ARM64..."
          pip install -r "$AGENT_DIR/requirements.txt" \
            -t "$BUILD_DIR/" \
            --platform manylinux2014_aarch64 \
            --only-binary=:all: \
            --python-version 3.13 \
            --upgrade

          # Create ZIP file
          echo "Creating ZIP file..."
          cd "$BUILD_DIR"
          zip -r "$ZIP_FILE" . -x "*.pyc" -x "*__pycache__*"

          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
          echo "Package created: $(du -h $ZIP_FILE | cut -f1)" >> $GITHUB_STEP_SUMMARY

      - name: Get S3 bucket name
        id: get_bucket
        run: |
          STACK_NAME="multi-agent-system-dev"
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].Outputs[?OutputKey=='BoilerplateAgentDeploymentBucket'].OutputValue" \
            --output text 2>/dev/null || echo "")

          if [ -z "$BUCKET_NAME" ]; then
            echo "Bucket not found yet - will be created in runtime deployment"
            echo "bucket_exists=false" >> $GITHUB_OUTPUT
          else
            echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
            echo "bucket_exists=true" >> $GITHUB_OUTPUT
            echo "Found bucket: $BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload to S3
        if: steps.get_bucket.outputs.bucket_exists == 'true'
        run: |
          BUCKET_NAME="${{ steps.get_bucket.outputs.bucket_name }}"
          aws s3 cp "$ZIP_FILE" "s3://$BUCKET_NAME/boilerplate-agent.zip"
          echo "✓ Uploaded to s3://$BUCKET_NAME/boilerplate-agent.zip" >> $GITHUB_STEP_SUMMARY

      - name: Save artifact for later upload
        if: steps.get_bucket.outputs.bucket_exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: boilerplate-agent-zip
          path: /tmp/boilerplate-agent.zip
          retention-days: 1

  deploy-runtime:
    name: Deploy AgentCore Runtime
    needs: [deploy-ecr, build-and-push-image, package-and-upload-agent]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.PIPELINE_EXECUTION_ROLE }}

      - name: Derive Image URI
        id: image
        run: |
          ECR_URI='${{ needs.deploy-ecr.outputs.ecr_uri }}'
          IMAGE_TAG=latest
          if [ -z "$ECR_URI" ]; then
            echo "ECR URI missing" >&2; exit 1; fi
          FULL_URI="$ECR_URI:$IMAGE_TAG"
          echo "container_uri=$FULL_URI" >> $GITHUB_OUTPUT
          echo "Using container image: $FULL_URI" >> $GITHUB_STEP_SUMMARY

      # Skip Validate since sam version to 1.144.0 does not support AWS::BedrockAgentCore::Runtime
      # - name: Validate runtime template
      #   working-directory: backend
      #   run: |
      #     sam validate -t template.yaml

      - name: Deploy runtime stack
        working-directory: backend
        run: |
          sam build --template-file template.yaml
          sam deploy \
            --template-file template.yaml \
            --config-env dev \
            --s3-bucket "${{ secrets.ARTIFACTS_BUCKET_NAME }}" \
            --role-arn "${{ secrets.CLOUDFORMATION_EXECUTION_ROLE }}" \
            --parameter-overrides ContainerUri=${{ steps.image.outputs.container_uri }} \
            --no-fail-on-empty-changeset

      - name: Download agent artifact if needed
        if: needs.package-and-upload-agent.outputs.bucket_exists == 'false'
        uses: actions/download-artifact@v4
        with:
          name: boilerplate-agent-zip
          path: /tmp

      - name: Upload agent to S3 after stack creation
        run: |
          STACK_NAME="multi-agent-system-dev"
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].Outputs[?OutputKey=='BoilerplateAgentDeploymentBucket'].OutputValue" \
            --output text)

          if [ -f "/tmp/boilerplate-agent.zip" ]; then
            echo "Uploading agent ZIP to newly created bucket..."
            aws s3 cp /tmp/boilerplate-agent.zip "s3://$BUCKET_NAME/boilerplate-agent.zip"
            echo "✓ Uploaded to s3://$BUCKET_NAME/boilerplate-agent.zip" >> $GITHUB_STEP_SUMMARY
          else
            echo "Agent already uploaded in previous step" >> $GITHUB_STEP_SUMMARY
          fi